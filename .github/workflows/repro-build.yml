name: Reproducible Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install staticcheck (go-based)
        run: |
          set -euo pipefail
          echo "Installing staticcheck"
          go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Install golangci-lint
        run: |
          set -euo pipefail
          echo "Installing golangci-lint"
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b /usr/local/bin v1.59.0

      - name: Run golangci-lint
        run: |
          set -euo pipefail
          echo "Running golangci-lint"
          golangci-lint run ./... --timeout 5m

      - name: Run staticcheck
        run: |
          set -euo pipefail
          echo "Running staticcheck"
          staticcheck ./...

      - name: Run project static analysis script
        run: |
          set -euo pipefail
          echo "Running scripts/analysis/run_static_analysis.sh"
          ./scripts/analysis/run_static_analysis.sh

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: analysis-artifacts
          path: analysis/**

      - name: Build reproducible artifacts
        run: |
          set -euo pipefail
          mkdir -p out
          
          # Download all Go modules to ensure dependencies are available
          echo "Downloading Go modules..."
          go mod download
          
          # Run unit tests for newly added utilities and collect coverage
          echo "Running unit tests for new utilities..."
          go test ./internal/releasemgr ./internal/backupmgr -coverprofile=coverage_utils.out -v || (echo 'tests failed' && exit 1)
          
          # Compute coverage percentage for the utilities and enforce threshold
          COVER_UTILS=$(go tool cover -func=coverage_utils.out | grep total: | awk '{print $3}')
          echo "Utilities coverage: $COVER_UTILS"
          
          # Strip trailing percent sign and convert to integer (rounded)
          NUM=$(echo "$COVER_UTILS" | sed 's/%$//')
          PERCENT=$(printf "%.0f" "$NUM")
          echo "Utilities coverage (rounded percent): $PERCENT"
          
          # Enforce 80% coverage threshold
          if [ "$PERCENT" -lt 80 ]; then
            echo "ERROR: Coverage for utilities is below 80%: $COVER_UTILS" >&2
            exit 1
          fi
          
          echo "âœ“ Coverage threshold passed (${PERCENT}% >= 80%)"

          # Build full product via release-manager (which downloads modules)
          echo "Building full product binaries..."
          go run ./cmd/release-manager --version "${GITHUB_REF#refs/tags/}" --out out
          
          # List generated artifacts
          echo "Generated artifacts:"
          ls -lh out/ || true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage_utils.out
            analysis/coverage*

      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            out/n-audit-sentinel-${{ github.ref_name }}-linux-amd64.tar.gz
            out/n-audit-sentinel-${{ github.ref_name }}-linux-amd64.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          